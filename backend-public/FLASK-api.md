# Flask LLM API 문서

## 📋 개요

Flask 기반 LLM 레시피 추천 서비스 API 문서입니다.

---

## 🔐 인증

대부분의 API는 JWT 인증이 필요합니다.

### 요청 헤더
```
Authorization: Bearer <JWT_TOKEN>
```

---

## 📡 API 엔드포인트

### 1. Health Check

**GET** `/llm/health`

서버 상태 및 데이터베이스 연결 확인

#### 응답 예시
```json
{
    "database": "connected",
    "message": "LLM Service is running",
    "status": "ok"
}
```

---

### 2. 레시피 생성 (로그인 사용자)

**POST** `/llm/generate`

🔒 **인증 필요**

로그인한 사용자를 위한 레시피 추천 API (횟수 제한 없음)

#### 요청 본문
```json
{
  "question": "다이어트에 좋은 저칼로리 요리 추천해줘"
}
```

#### 응답 예시
```json
{
    "results": "---\n### 🍳 저칼로리 다이어트에 좋은 쇠미역무침! [[레시피 보러가기]](https://www.10000recipe.com/recipe/6918518)\n- **종류**: 한식 / 한국\n- **재료**: \n  - 염장쇠 미역 220g\n  - 적양파 중간크기 1개\n  - 고추가루 1큰술\n  - 다진마늘 1/2큰술\n  - 사과식초 2큰술\n  - 소금 1꼬집\n  - 설탕 1큰술\n  - 매실청 1큰술\n  - 참기름 1/2큰술\n  - 통깨 1/2큰술\n  \n- **👨‍🍳 조리법 요약**:\n  1. 염장 쇠미역을 찬물에 문질러 씻고 10분간 담가 염분을 빼주세요.\n  2. 염분을 뺀 쇠미역을 먹기 좋은 크기로 자릅니다.\n  3. 적양파를 얇게 썰어 쇠미역에 넣습니다.\n  4. 고추가루, 다진마늘, 소금, 설탕, 사과식초, 매실청, 통깨를 넣고 잘 무쳐줍니다.\n  5. 마지막으로 참기름을 넣고 가볍게 무쳐서 완성합니다.\n\n---\n\n### 🍳 손님초대요리로도 좋은 저칼로리 피자_포두부 미니 크림 피자 [[레시피 보러가기]](https://www.10000recipe.com/recipe/7037375)\n- **종류**: 한식 / 한국\n- **재료**: \n  - 포두부 1장\n  - 생크림 1팩 (휘핑크림 200ml)\n  - 새우 큰거 5개 (작은거면 9개)\n  - 방울토마토 5알\n  - 옥수수콘 2숟가락 (생략 가능)\n  - 루꼴라 1줌\n  \n- **👨‍🍳 조리법 요약**:\n  1. 포두부를 만두피 모양으로 9장 잘라 준비합니다.\n  2. 생크림을 팬에 붓고 다진마늘을 넣어 중불에서 10분간 끓여 마늘크림을 만듭니다.\n  3. 포두부를 겹쳐서 깔고 마늘크림을 올립니다.\n  4. 새우, 방울토마토, 옥수수콘을 올리고 다시 마늘크림을 조금 더 얹습니다.\n  5. 오븐이나 에어프라이어에서 180도에서 9분간 구워 완성합니다.\n\n---\n\n### 🍳 칼로리 다이어트 (먹을수록 가벼워지는 저칼로리 음식은?) [[레시피 보러가기]](https://www.10000recipe.com/recipe/6844690)\n- **종류**: 한식 / 한국\n- **재료**: (정보 없음)\n  \n- **👨‍🍳 조리법 요약**: (정보 없음)\n\n---\n\n### 🍳 칼로리는 가볍게 속은 든든한 다이어트한끼 [[레시피 보러가기]](https://www.10000recipe.com/recipe/7062165)\n- **종류**: 한식 / 한국\n- **재료**: \n  - 밥 150g\n  - 오이 1/4\n  - 참치 1/2\n  - 두부 1/2모\n  - 도시락김 1개\n  - 맛간장 1.5T\n  - 알룰로스 1.5T\n  \n- **👨‍🍳 조리법 요약**:\n  1. 두부를 잘라 키친타올로 물기를 제거합니다.\n  2. 오이를 껍질을 벗기고 잘게 썰어 준비합니다.\n  3. 참치는 국물을 버리고 반만 준비합니다.\n  4. 모든 재료를 대접에 넣고 맛간장과 알룰로스를 넣고 비벼줍니다.\n\n---\n\n🔴 **중요 지침 (Chef's Pick)**: \n### 🌟 셰프의 원픽(Chef's Pick)\n\"손님, 질문하신 내용과 오늘 같은 분위기를 고려했을 때 **저칼로리 다이어트에 좋은 쇠미역무침** 요리가 가장 잘 어울릴 것 같습니다. 이 요리는 신선한 미역과 아삭한 적양파가 어우러져 상큼하고 건강한 맛을 자랑하며, 다이어트에도 적합한 저칼로리 간식으로 손쉽게 만들 수 있습니다. 건강한 식단을 원하신다면 이 요리를 추천드립니다!\"",
    "success": true
}
```

---

### 3. 레시피 생성 (비로그인 사용자)

**POST** `/llm/generate/anonymous`

비로그인 사용자를 위한 레시피 추천 API (10회 제한)

#### 요청 본문
```json
{
  "question": "간단한 아침 식사 추천해줘"
}
```

#### 응답 예시
```json
{
    "results": "---\n### 🍳 저칼로리 다이어트에 좋은 쇠미역무침! [[레시피 보러가기]](https://www.10000recipe.com/recipe/6918518)\n- **종류**: 한식 / 한국\n- **재료**: \n  - 염장쇠 미역 220g\n  - 적양파 중간크기 1개\n  - 고추가루 1큰술\n  - 다진마늘 1/2큰술\n  - 사과식초 2큰술\n  - 소금 1꼬집\n  - 설탕 1큰술\n  - 매실청 1큰술\n  - 참기름 1/2큰술\n  - 통깨 1/2큰술\n  \n- **👨‍🍳 조리법 요약**:\n  1. 염장 쇠미역을 찬물에 문질러 씻고 10분간 담가 염분을 빼주세요.\n  2. 염분을 뺀 쇠미역을 먹기 좋은 크기로 자릅니다.\n  3. 적양파를 얇게 썰어 쇠미역에 넣습니다.\n  4. 고추가루, 다진마늘, 소금, 설탕, 사과식초, 매실청, 통깨를 넣고 잘 무쳐줍니다.\n  5. 마지막으로 참기름을 넣고 가볍게 무쳐서 완성합니다.\n\n---\n\n### 🍳 손님초대요리로도 좋은 저칼로리 피자_포두부 미니 크림 피자 [[레시피 보러가기]](https://www.10000recipe.com/recipe/7037375)\n- **종류**: 한식 / 한국\n- **재료**: \n  - 포두부 1장\n  - 생크림 1팩 (휘핑크림 200ml)\n  - 새우 큰거 5개 (작은거면 9개)\n  - 방울토마토 5알\n  - 옥수수콘 2숟가락 (생략 가능)\n  - 루꼴라 1줌\n  \n- **👨‍🍳 조리법 요약**:\n  1. 포두부를 만두피 모양으로 9장 잘라 준비합니다.\n  2. 생크림을 팬에 붓고 다진마늘을 넣어 중불에서 10분간 끓여 마늘크림을 만듭니다.\n  3. 포두부를 겹쳐서 깔고 마늘크림을 올립니다.\n  4. 새우, 방울토마토, 옥수수콘을 올리고 다시 마늘크림을 조금 더 얹습니다.\n  5. 오븐이나 에어프라이어에서 180도에서 9분간 구워 완성합니다.\n\n---\n\n### 🍳 칼로리 다이어트 (먹을수록 가벼워지는 저칼로리 음식은?) [[레시피 보러가기]](https://www.10000recipe.com/recipe/6844690)\n- **종류**: 한식 / 한국\n- **재료**: (정보 없음)\n  \n- **👨‍🍳 조리법 요약**: (정보 없음)\n\n---\n\n### 🍳 칼로리는 가볍게 속은 든든한 다이어트한끼 [[레시피 보러가기]](https://www.10000recipe.com/recipe/7062165)\n- **종류**: 한식 / 한국\n- **재료**: \n  - 밥 150g\n  - 오이 1/4\n  - 참치 1/2\n  - 두부 1/2모\n  - 도시락김 1개\n  - 맛간장 1.5T\n  - 알룰로스 1.5T\n  \n- **👨‍🍳 조리법 요약**:\n  1. 두부를 잘라 키친타올로 물기를 제거합니다.\n  2. 오이를 껍질을 벗기고 잘게 썰어 준비합니다.\n  3. 참치는 국물을 버리고 반만 준비합니다.\n  4. 모든 재료를 대접에 넣고 맛간장과 알룰로스를 넣고 비벼줍니다.\n\n---\n\n🔴 **중요 지침 (Chef's Pick)**: \n### 🌟 셰프의 원픽(Chef's Pick)\n\"손님, 질문하신 내용과 오늘 같은 분위기를 고려했을 때 **저칼로리 다이어트에 좋은 쇠미역무침** 요리가 가장 잘 어울릴 것 같습니다. 이 요리는 신선한 미역과 아삭한 적양파가 어우러져 상큼하고 건강한 맛을 자랑하며, 다이어트에도 적합한 저칼로리 간식으로 손쉽게 만들 수 있습니다. 건강한 식단을 원하신다면 이 요리를 추천드립니다!\"",
    "success": true
}
```

#### 오류 응답 (횟수 초과)
```json
{
  "error": "무료 체험 횟수(10회)를 모두 소진했습니다. 더 이용하시려면 로그인해주세요.",
  "remaining_queries": 0
}
```

---

## 📚 검색 기록 API

### 4. 검색 기록 목록 조회

**GET** `/llm/history`

🔒 **인증 필요**

사용자의 검색 기록 목록을 조회합니다.

#### 쿼리 파라미터

| 파라미터 | 타입 | 기본값 | 설명 |
|---------|------|--------|------|
| `limit` | integer | 10 | 조회할 개수 (최대 100) |
| `offset` | integer | 0 | 건너뛸 개수 (페이지네이션) |
| `include_results` | boolean | false | 검색 결과 포함 여부 |

#### 요청 예시
```
GET /llm/history?limit=20&offset=0&include_results=true
```

#### 응답 예시
```json
{
    "history": [
        {
            "created_at": "2025-11-23T12:29:13.409180+00:00",
            "id": 1,
            "structured_query": {
                "query": "다이어트에 좋은 저칼로리 요리 추천해줘"
            },
            "user_query": "다이어트에 좋은 저칼로리 요리 추천해줘"
        }
    ],
    "limit": 10,
    "offset": 0,
    "success": true,
    "total_count": 1
}
```

---

### 5. 검색 기록 상세 조회

**GET** `/llm/history/<history_id>`

🔒 **인증 필요**

특정 검색 기록의 상세 정보를 조회합니다.

#### 경로 파라미터
- `history_id`: 검색 기록 ID (integer)

#### 요청 예시
```
GET /llm/history/123
```

#### 응답 예시
```json
{
    "history": {
        "created_at": "2025-11-23T12:29:13.409180+00:00",
        "id": 1,
        "search_results": {
            "response": "---\n### 🍳 저칼로리 다이어트에 좋은 쇠미역무침! [[레시피 보러가기]](https://www.10000recipe.com/recipe/6918518)\n- **종류**: 한식 / 한국\n- **재료**: \n  - 염장쇠 미역 220g\n  - 적양파 중간크기 1개\n  - 고추가루 1큰술\n  - 다진마늘 1/2큰술\n  - 사과식초 2큰술\n  - 소금 1꼬집\n  - 설탕 1큰술\n  - 매실청 1큰술\n  - 참기름 1/2큰술\n  - 통깨 1/2큰술\n  \n- **👨‍🍳 조리법 요약**:\n  1. 염장 쇠미역을 찬물에 문질러 씻고 10분간 담가 염분을 빼주세요.\n  2. 염분을 뺀 쇠미역을 먹기 좋은 크기로 자릅니다.\n  3. 적양파를 얇게 썰어 쇠미역에 넣습니다.\n  4. 고추가루, 다진마늘, 소금, 설탕, 사과식초, 매실청, 통깨를 넣고 잘 무쳐줍니다.\n  5. 마지막으로 참기름을 넣고 가볍게 무쳐서 완성합니다.\n\n---\n\n### 🍳 손님초대요리로도 좋은 저칼로리 피자_포두부 미니 크림 피자 [[레시피 보러가기]](https://www.10000recipe.com/recipe/7037375)\n- **종류**: 한식 / 한국\n- **재료**: \n  - 포두부 1장\n  - 생크림 1팩 (휘핑크림 200ml)\n  - 새우 큰거 5개 (작은거면 9개)\n  - 방울토마토 5알\n  - 옥수수콘 2숟가락 (생략 가능)\n  - 루꼴라 1줌\n  \n- **👨‍🍳 조리법 요약**:\n  1. 포두부를 만두피 모양으로 9장 잘라 준비합니다.\n  2. 생크림을 팬에 붓고 다진마늘을 넣어 중불에서 10분간 끓여 마늘크림을 만듭니다.\n  3. 포두부를 3장씩 겹쳐 놓고 마늘크림을 올립니다.\n  4. 새우, 방울토마토, 옥수수콘을 올리고 다시 마늘크림을 조금 더 얹습니다.\n  5. 오븐이나 에어프라이어에서 180도에서 9분간 구워 완성합니다.\n\n---\n\n### 🍳 칼로리는 가볍게 속은 든든한 다이어트한끼 [[레시피 보러가기]](https://www.10000recipe.com/recipe/7062165)\n- **종류**: 한식 / 한국\n- **재료**: \n  - 밥 150g\n  - 오이 1/4\n  - 참치 1/2\n  - 두부 1/2모\n  - 도시락김 1개\n  - 맛간장 1.5T\n  - 알룰로스 1.5T\n  \n- **👨‍🍳 조리법 요약**:\n  1. 두부를 잘라 키친타올로 물기를 제거합니다.\n  2. 오이를 껍질을 벗기고 4등분하여 잘게 썹니다.\n  3. 참치는 국물을 버리고 반만 준비합니다.\n  4. 대접에 밥, 오이, 참치, 두부, 잘라놓은 김을 넣습니다.\n  5. 맛간장과 알룰로스를 넣고 비벼서 완성합니다.\n\n---\n\n### 🌟 셰프의 원픽(Chef's Pick)\n\"손님, 질문하신 내용과 오늘 같은 분위기를 고려했을 때 **저칼로리 다이어트에 좋은 쇠미역무침** 요리가 가장 잘 어울릴 것 같습니다. 이 요리는 신선한 미역과 아삭한 적양파가 어우러져 상큼하고 건강한 맛을 자랑하며, 다이어트에도 적합한 저칼로리 간식으로 손쉽게 만들 수 있습니다. 건강한 식단을 원하신다면 이 요리를 추천드립니다!\""
        },
        "structured_query": {
            "query": "다이어트에 좋은 저칼로리 요리 추천해줘"
        },
        "user_id": "0993573f-a70d-4b91-b903-79b6580e487d",
        "user_query": "다이어트에 좋은 저칼로리 요리 추천해줘"
    },
    "success": true
}
```

#### 오류 응답 (404)
```json
{
  "error": "검색 기록을 찾을 수 없습니다."
}
```

---

### 6. 검색 기록 삭제 (개별)

**DELETE** `/llm/history/<history_id>`

🔒 **인증 필요**

특정 검색 기록을 삭제합니다.

#### 경로 파라미터
- `history_id`: 검색 기록 ID (integer)

#### 요청 예시
```
DELETE /llm/history/123
```

#### 응답 예시
```json
{
    "message": "검색 기록이 삭제되었습니다.",
    "success": true
}
```

#### 오류 응답 (404)
```json
{
  "error": "검색 기록을 찾을 수 없습니다."
}
```

---

### 7. 검색 기록 전체 삭제

**DELETE** `/llm/history`

🔒 **인증 필요**

사용자의 모든 검색 기록을 삭제합니다.

#### 요청 예시
```
DELETE /llm/history
```

#### 응답 예시
```json
{
    "deleted_count": 0,
    "message": "0개의 검색 기록이 삭제되었습니다.",
    "success": true
}
```

--------위까지 최신화 완료(11/24)-----

## 🔒 보안 및 권한

### 인증 방식
- JWT (RS256 알고리즘)
- 공개키 기반 토큰 검증

### 권한 제어
- 사용자는 **본인의 검색 기록만** 조회/삭제 가능
- `user_id`는 JWT 토큰에서 자동으로 추출됨

---

## ⚠️ 오류 응답

### 400 Bad Request
```json
{
  "error": "질문(question)이 필요합니다."
}
```

### 401 Unauthorized
```json
{
  "error": "Authorization 헤더가 없거나 'Bearer' 타입이 아닙니다."
}
```

### 404 Not Found
```json
{
  "error": "검색 기록을 찾을 수 없습니다."
}
```

### 429 Too Many Requests
```json
{
  "error": "무료 체험 횟수(10회)를 모두 소진했습니다. 더 이용하시려면 로그인해주세요.",
  "remaining_queries": 0
}
```

### 500 Internal Server Error
```json
{
  "error": "서버 오류가 발생했습니다.",
  "details": "..."
}
```

---

## 📊 사용 예시

### cURL 예시

#### 1. 검색 기록 조회
```bash
curl -X GET "http://localhost:8000/llm/history?limit=10&offset=0" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

#### 2. 특정 기록 상세 조회
```bash
curl -X GET "http://localhost:8000/llm/history/123" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

#### 3. 검색 기록 삭제
```bash
curl -X DELETE "http://localhost:8000/llm/history/123" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

#### 4. 전체 기록 삭제
```bash
curl -X DELETE "http://localhost:8000/llm/history" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

### JavaScript (Fetch) 예시

```javascript
// 검색 기록 조회
const response = await fetch('http://localhost:8000/llm/history?limit=10', {
  method: 'GET',
  headers: {
    'Authorization': `Bearer ${jwtToken}`
  }
});

const data = await response.json();
console.log(data.history);
```

---

## 🚀 배포 정보

### 로컬 개발
```bash
# Flask 개발 서버
flask run --port 8000

# Gunicorn (프로덕션)
gunicorn -b 0.0.0.0:8000 app:app
```

### Docker
```bash
# 컨테이너 시작
docker-compose up -d flask

# 로그 확인
docker-compose logs -f flask
```

---

## 📝 변경 이력

### v1.1.0 (2025-11-23)
- ✅ 검색 기록 조회 API 추가
- ✅ 검색 기록 상세 조회 API 추가
- ✅ 검색 기록 삭제 API 추가 (개별/전체)
- ✅ 페이지네이션 지원

### v1.0.0 (Initial)
- ✅ 레시피 생성 API (로그인/비로그인)
- ✅ Health Check API
- ✅ JWT 인증 시스템
