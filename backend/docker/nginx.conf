events {}

http {
  upstream nest  { server nest:3000; }
  upstream flask { server flask:8000; }

  server {
    listen 80;

    # CORS 헤더 추가 (개발용: 모든 도메인 허용)
    # add_header Access-Control-Allow-Origin "*" always;
    # add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS" always;
    # add_header Access-Control-Allow-Headers "Authorization, Content-Type" always;

    # 업로드 파일 크기 제한
    client_max_body_size 10M;

    location /api/ {
      proxy_pass http://nest;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /llm/ {
      proxy_pass http://flask;
      proxy_read_timeout 120s;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 업로드된 이미지 파일 서빙
    location /uploads/ {
      alias /var/www/uploads/;
      expires 30d;
      add_header Cache-Control "public, immutable";
    }

    location /health { return 200 "ok"; }
  }
}
